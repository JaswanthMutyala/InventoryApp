{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///E:/inventory-app/lib/db.js"],"sourcesContent":["import mysql from \"mysql2/promise\";\r\n\r\nlet pool;\r\n\r\n// MySQL Connection Pool\r\nexport async function getDb() {\r\n  if (!pool) {\r\n    pool = mysql.createPool({\r\n      host: \"localhost\",\r\n      user: \"inventory\",\r\n      password: \"Mutyala@4\",  // MySQL user password\r\n      database: \"inventory\",       // Your MySQL DB name\r\n      waitForConnections: true,\r\n      connectionLimit: 10,\r\n    });\r\n  }\r\n  return pool;\r\n}\r\n\r\n/* ------------------------------------------------------------------\r\n   Database Functions (MySQL versions of your previous SQLite code)\r\n------------------------------------------------------------------ */\r\n\r\n// Clear all data (products + transactions ONLY, like before)\r\nexport async function clearAllData() {\r\n  const db = await getDb();\r\n\r\n  try {\r\n    await db.query(\"DELETE FROM transactions\");\r\n    await db.query(\"DELETE FROM products\");\r\n    return true;\r\n  } catch (err) {\r\n    console.error(\"Error clearing data:\", err);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Get user statistics\r\nexport async function getUserStats() {\r\n  const db = await getDb();\r\n\r\n  try {\r\n    const [[admins]] = await db.query(\r\n      \"SELECT COUNT(*) AS count FROM users WHERE role = 'admin'\"\r\n    );\r\n    const [[members]] = await db.query(\r\n      \"SELECT COUNT(*) AS count FROM users WHERE role = 'member'\"\r\n    );\r\n\r\n    return {\r\n      adminCount: admins.count || 0,\r\n      memberCount: members.count || 0,\r\n    };\r\n  } catch (err) {\r\n    console.error(\"Error getting user stats:\", err);\r\n    return { adminCount: 0, memberCount: 0 };\r\n  }\r\n}\r\n\r\n// Get all users\r\nexport async function getAllUsers() {\r\n  const db = await getDb();\r\n\r\n  try {\r\n    const [rows] = await db.query(\r\n      \"SELECT id, student_id, name, role, password, created_at FROM users ORDER BY role DESC, created_at ASC\"\r\n    );\r\n    return rows;\r\n  } catch (err) {\r\n    console.error(\"Error getting all users:\", err);\r\n    return [];\r\n  }\r\n}\r\n\r\n// Delete user + their transactions\r\nexport async function deleteUser(userId) {\r\n  const db = await getDb();\r\n\r\n  try {\r\n    await db.query(\"DELETE FROM transactions WHERE user_id = ?\", [userId]);\r\n    await db.query(\"DELETE FROM users WHERE id = ?\", [userId]);\r\n    return true;\r\n  } catch (err) {\r\n    console.error(\"Error deleting user:\", err);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Log user access\r\nexport async function logUserAccess(userId, studentId, name, role) {\r\n  const db = await getDb();\r\n\r\n  try {\r\n    await db.query(\r\n      \"INSERT INTO access_logs (user_id, student_id, name, role) VALUES (?, ?, ?, ?)\",\r\n      [userId, studentId, name, role]\r\n    );\r\n    return true;\r\n  } catch (err) {\r\n    console.error(\"Error logging access:\", err);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Get all access logs\r\nexport async function getAccessLogs() {\r\n  const db = await getDb();\r\n\r\n  try {\r\n    const [rows] = await db.query(\r\n      \"SELECT id, user_id, student_id, name, role, accessed_at FROM access_logs ORDER BY accessed_at DESC\"\r\n    );\r\n    return rows;\r\n  } catch (err) {\r\n    console.error(\"Error getting access logs:\", err);\r\n    return [];\r\n  }\r\n}\r\n\r\n// Default export (optional for compatibility)\r\nexport default {\r\n  getDb,\r\n  clearAllData,\r\n  getUserStats,\r\n  getAllUsers,\r\n  deleteUser,\r\n  logUserAccess,\r\n  getAccessLogs,\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;;AAEA,IAAI;AAGG,eAAe;IACpB,IAAI,CAAC,MAAM;QACT,OAAO,8IAAK,CAAC,UAAU,CAAC;YACtB,MAAM;YACN,MAAM;YACN,UAAU;YACV,UAAU;YACV,oBAAoB;YACpB,iBAAiB;QACnB;IACF;IACA,OAAO;AACT;AAOO,eAAe;IACpB,MAAM,KAAK,MAAM;IAEjB,IAAI;QACF,MAAM,GAAG,KAAK,CAAC;QACf,MAAM,GAAG,KAAK,CAAC;QACf,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO;IACT;AACF;AAGO,eAAe;IACpB,MAAM,KAAK,MAAM;IAEjB,IAAI;QACF,MAAM,CAAC,CAAC,OAAO,CAAC,GAAG,MAAM,GAAG,KAAK,CAC/B;QAEF,MAAM,CAAC,CAAC,QAAQ,CAAC,GAAG,MAAM,GAAG,KAAK,CAChC;QAGF,OAAO;YACL,YAAY,OAAO,KAAK,IAAI;YAC5B,aAAa,QAAQ,KAAK,IAAI;QAChC;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO;YAAE,YAAY;YAAG,aAAa;QAAE;IACzC;AACF;AAGO,eAAe;IACpB,MAAM,KAAK,MAAM;IAEjB,IAAI;QACF,MAAM,CAAC,KAAK,GAAG,MAAM,GAAG,KAAK,CAC3B;QAEF,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,EAAE;IACX;AACF;AAGO,eAAe,WAAW,MAAM;IACrC,MAAM,KAAK,MAAM;IAEjB,IAAI;QACF,MAAM,GAAG,KAAK,CAAC,8CAA8C;YAAC;SAAO;QACrE,MAAM,GAAG,KAAK,CAAC,kCAAkC;YAAC;SAAO;QACzD,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO;IACT;AACF;AAGO,eAAe,cAAc,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,IAAI;IAC/D,MAAM,KAAK,MAAM;IAEjB,IAAI;QACF,MAAM,GAAG,KAAK,CACZ,iFACA;YAAC;YAAQ;YAAW;YAAM;SAAK;QAEjC,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO;IACT;AACF;AAGO,eAAe;IACpB,MAAM,KAAK,MAAM;IAEjB,IAAI;QACF,MAAM,CAAC,KAAK,GAAG,MAAM,GAAG,KAAK,CAC3B;QAEF,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,EAAE;IACX;AACF;uCAGe;IACb;IACA;IACA;IACA;IACA;IACA;IACA;AACF"}},
    {"offset": {"line": 243, "column": 0}, "map": {"version":3,"sources":["file:///E:/inventory-app/app/api/transactions/route.js"],"sourcesContent":["import { getDb } from '@/lib/db';\r\nimport { NextResponse } from 'next/server';\r\n\r\nexport async function GET() {\r\n  try {\r\n    const db = await getDb();\r\n    const [transactions] = await db.query(`\r\n      SELECT t.*, p.name as product_name, u.name as user_name\r\n      FROM transactions t\r\n      JOIN products p ON t.product_id = p.id\r\n      JOIN users u ON t.user_id = u.id\r\n      ORDER BY t.timestamp DESC\r\n    `);\r\n    return NextResponse.json(transactions);\r\n  } catch (error) {\r\n    return NextResponse.json({ error: 'Failed to fetch transactions' }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function POST(request) {\r\n  try {\r\n    const { product_id, user_id, type, quantity } = await request.json();\r\n    if (!product_id || !user_id || !type || !quantity) return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });\r\n\r\n    const db = await getDb();\r\n\r\n    // Get product\r\n    const [productRows] = await db.query('SELECT quantity FROM products WHERE id = ?', [product_id]);\r\n    const product = productRows[0];\r\n    if (!product) return NextResponse.json({ error: 'Product not found' }, { status: 404 });\r\n\r\n    let newQuantity = product.quantity;\r\n\r\n    if (type === 'CHECKOUT') {\r\n      if (product.quantity < quantity) return NextResponse.json({ error: `Insufficient quantity. Available: ${product.quantity}` }, { status: 400 });\r\n      newQuantity -= quantity;\r\n    } else if (type === 'CHECKIN') {\r\n      const [checkedOut] = await db.query(`\r\n        SELECT SUM(quantity) as total_checked_out FROM transactions\r\n        WHERE user_id = ? AND product_id = ? AND type='CHECKOUT'\r\n      `, [user_id, product_id]);\r\n      const [checkedIn] = await db.query(`\r\n        SELECT SUM(quantity) as total_checked_in FROM transactions\r\n        WHERE user_id = ? AND product_id = ? AND type='CHECKIN'\r\n      `, [user_id, product_id]);\r\n\r\n      const outstanding = (checkedOut[0]?.total_checked_out || 0) - (checkedIn[0]?.total_checked_in || 0);\r\n      if (quantity > outstanding) return NextResponse.json({ error: `You can return only ${outstanding} units` }, { status: 400 });\r\n      newQuantity += quantity;\r\n    } else {\r\n      return NextResponse.json({ error: 'Invalid transaction type' }, { status: 400 });\r\n    }\r\n\r\n    await db.query('UPDATE products SET quantity = ? WHERE id = ?', [newQuantity, product_id]);\r\n    const [result] = await db.query('INSERT INTO transactions (product_id, user_id, type, quantity) VALUES (?, ?, ?, ?)', [product_id, user_id, type, quantity]);\r\n\r\n    return NextResponse.json({ id: result.insertId, product_id, user_id, type, quantity, timestamp: new Date().toISOString() });\r\n  } catch (error) {\r\n    return NextResponse.json({ error: error.message || 'Transaction failed' }, { status: 400 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,KAAK,MAAM,IAAA,oHAAK;QACtB,MAAM,CAAC,aAAa,GAAG,MAAM,GAAG,KAAK,CAAC,CAAC;;;;;;IAMvC,CAAC;QACD,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA+B,GAAG;YAAE,QAAQ;QAAI;IACpF;AACF;AAEO,eAAe,KAAK,OAAO;IAChC,IAAI;QACF,MAAM,EAAE,UAAU,EAAE,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,GAAG,MAAM,QAAQ,IAAI;QAClE,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,QAAQ,CAAC,UAAU,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;QAEhI,MAAM,KAAK,MAAM,IAAA,oHAAK;QAEtB,cAAc;QACd,MAAM,CAAC,YAAY,GAAG,MAAM,GAAG,KAAK,CAAC,8CAA8C;YAAC;SAAW;QAC/F,MAAM,UAAU,WAAW,CAAC,EAAE;QAC9B,IAAI,CAAC,SAAS,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAoB,GAAG;YAAE,QAAQ;QAAI;QAErF,IAAI,cAAc,QAAQ,QAAQ;QAElC,IAAI,SAAS,YAAY;YACvB,IAAI,QAAQ,QAAQ,GAAG,UAAU,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,CAAC,kCAAkC,EAAE,QAAQ,QAAQ,EAAE;YAAC,GAAG;gBAAE,QAAQ;YAAI;YAC5I,eAAe;QACjB,OAAO,IAAI,SAAS,WAAW;YAC7B,MAAM,CAAC,WAAW,GAAG,MAAM,GAAG,KAAK,CAAC,CAAC;;;MAGrC,CAAC,EAAE;gBAAC;gBAAS;aAAW;YACxB,MAAM,CAAC,UAAU,GAAG,MAAM,GAAG,KAAK,CAAC,CAAC;;;MAGpC,CAAC,EAAE;gBAAC;gBAAS;aAAW;YAExB,MAAM,cAAc,CAAC,UAAU,CAAC,EAAE,EAAE,qBAAqB,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,oBAAoB,CAAC;YAClG,IAAI,WAAW,aAAa,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,CAAC,oBAAoB,EAAE,YAAY,MAAM,CAAC;YAAC,GAAG;gBAAE,QAAQ;YAAI;YAC1H,eAAe;QACjB,OAAO;YACL,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,MAAM,GAAG,KAAK,CAAC,iDAAiD;YAAC;YAAa;SAAW;QACzF,MAAM,CAAC,OAAO,GAAG,MAAM,GAAG,KAAK,CAAC,sFAAsF;YAAC;YAAY;YAAS;YAAM;SAAS;QAE3J,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI,OAAO,QAAQ;YAAE;YAAY;YAAS;YAAM;YAAU,WAAW,IAAI,OAAO,WAAW;QAAG;IAC3H,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO,IAAI;QAAqB,GAAG;YAAE,QAAQ;QAAI;IAC3F;AACF"}}]
}